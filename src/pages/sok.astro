---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog');

// Create search index data
const searchIndex = allPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description || '',
  category: post.data.category || '',
  tags: post.data.tags || [],
  pubDate: post.data.pubDate.toISOString(),
  heroImage: post.data.heroImage || null,
}));
---

<BaseLayout title="Sök" description="Sök bland alla guider och artiklar på SmartHubb.se">

  <!-- Page Header -->
  <div class="blog-header">
    <div class="container">
      <h1>Sök</h1>
      <p>Hitta guider och artiklar om smarta hem</p>
    </div>
  </div>

  <!-- Search Section -->
  <section class="section">
    <div class="container">
      <div class="search-wrapper">
        <div class="search-input-wrapper">
          <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
          </svg>
          <input
            type="search"
            id="search-input"
            class="search-input"
            placeholder="Sök efter guider, produkter, protokoll..."
            autofocus
          />
          <button id="clear-search" class="clear-search" aria-label="Rensa sökning" style="display: none;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div id="search-stats" class="search-stats"></div>

        <div id="search-results" class="search-results">
          <p class="search-placeholder">Skriv för att börja söka...</p>
        </div>

        <!-- Popular Searches -->
        <div id="popular-searches" class="popular-searches">
          <h3>Populära sökningar</h3>
          <div class="popular-tags">
            <button class="popular-tag" data-search="Home Assistant">Home Assistant</button>
            <button class="popular-tag" data-search="Zigbee">Zigbee</button>
            <button class="popular-tag" data-search="Matter">Matter</button>
            <button class="popular-tag" data-search="belysning">Belysning</button>
            <button class="popular-tag" data-search="säkerhet">Säkerhet</button>
          </div>
        </div>
      </div>
    </div>
  </section>

</BaseLayout>

<script define:vars={{ searchIndex }}>
  const input = document.getElementById('search-input');
  const resultsContainer = document.getElementById('search-results');
  const statsContainer = document.getElementById('search-stats');
  const clearButton = document.getElementById('clear-search');
  const popularSearches = document.getElementById('popular-searches');

  // Simple search function
  function search(query) {
    if (!query || query.trim().length < 2) {
      return [];
    }

    const searchTerms = query.toLowerCase().trim().split(/\s+/);

    return searchIndex
      .map(post => {
        let score = 0;
        const titleLower = post.title.toLowerCase();
        const descLower = post.description.toLowerCase();
        const categoryLower = post.category.toLowerCase();
        const tagsLower = post.tags.map(t => t.toLowerCase());

        searchTerms.forEach(term => {
          // Title match (highest priority)
          if (titleLower.includes(term)) {
            score += 10;
            if (titleLower.startsWith(term)) score += 5;
          }

          // Category match
          if (categoryLower.includes(term)) {
            score += 5;
          }

          // Tags match
          tagsLower.forEach(tag => {
            if (tag.includes(term)) score += 3;
          });

          // Description match
          if (descLower.includes(term)) {
            score += 2;
          }
        });

        return { ...post, score };
      })
      .filter(post => post.score > 0)
      .sort((a, b) => b.score - a.score);
  }

  function highlightText(text, query) {
    if (!query) return text;
    const terms = query.trim().split(/\s+/);
    let result = text;
    terms.forEach(term => {
      const regex = new RegExp(`(${term})`, 'gi');
      result = result.replace(regex, '<mark>$1</mark>');
    });
    return result;
  }

  function formatDate(dateString) {
    return new Intl.DateTimeFormat('sv-SE', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }).format(new Date(dateString));
  }

  function renderResults(results, query) {
    if (results.length === 0) {
      resultsContainer.innerHTML = `
        <div class="no-results">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
            <path d="M8 8l6 6M14 8l-6 6"/>
          </svg>
          <h3>Inga resultat hittades</h3>
          <p>Prova att söka med andra ord eller kolla våra populära sökningar nedan.</p>
        </div>
      `;
      statsContainer.textContent = '';
      popularSearches.style.display = 'block';
      return;
    }

    statsContainer.textContent = `${results.length} resultat för "${query}"`;
    popularSearches.style.display = 'none';

    resultsContainer.innerHTML = results.map(post => `
      <a href="/blog/${post.slug}" class="search-result-card">
        <div class="search-result-image">
          ${post.heroImage
            ? `<img src="${post.heroImage}" alt="${post.title}" loading="lazy" />`
            : `<div class="search-result-placeholder">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                  <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
              </div>`
          }
        </div>
        <div class="search-result-content">
          ${post.category ? `<span class="search-result-category">${post.category}</span>` : ''}
          <h3 class="search-result-title">${highlightText(post.title, query)}</h3>
          <p class="search-result-description">${highlightText(post.description, query)}</p>
          <div class="search-result-meta">
            <span>${formatDate(post.pubDate)}</span>
            ${post.tags.length > 0 ? `<span class="search-result-tags">${post.tags.slice(0, 3).map(t => `#${t}`).join(' ')}</span>` : ''}
          </div>
        </div>
      </a>
    `).join('');
  }

  function handleSearch() {
    const query = input.value;
    clearButton.style.display = query ? 'flex' : 'none';

    if (query.length < 2) {
      resultsContainer.innerHTML = '<p class="search-placeholder">Skriv för att börja söka...</p>';
      statsContainer.textContent = '';
      popularSearches.style.display = 'block';
      return;
    }

    const results = search(query);
    renderResults(results, query);
  }

  // Event listeners
  input.addEventListener('input', handleSearch);

  clearButton.addEventListener('click', () => {
    input.value = '';
    input.focus();
    handleSearch();
  });

  // Popular search buttons
  document.querySelectorAll('.popular-tag').forEach(button => {
    button.addEventListener('click', () => {
      input.value = button.dataset.search;
      handleSearch();
    });
  });

  // Check for query parameter
  const urlParams = new URLSearchParams(window.location.search);
  const queryParam = urlParams.get('q');
  if (queryParam) {
    input.value = queryParam;
    handleSearch();
  }
</script>

<style>
  .search-wrapper {
    max-width: 800px;
    margin: 0 auto;
  }

  .search-input-wrapper {
    position: relative;
    margin-bottom: var(--spacing-6);
  }

  .search-icon {
    position: absolute;
    left: var(--spacing-4);
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    color: var(--color-gray-400);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: var(--spacing-4) var(--spacing-12);
    font-size: var(--font-size-lg);
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-xl);
    background: white;
    transition: all var(--transition-fast);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 4px var(--color-primary-100);
  }

  .search-input::placeholder {
    color: var(--color-gray-400);
  }

  .clear-search {
    position: absolute;
    right: var(--spacing-4);
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-gray-100);
    border: none;
    border-radius: var(--radius-full);
    color: var(--color-gray-500);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .clear-search:hover {
    background: var(--color-gray-200);
    color: var(--color-gray-700);
  }

  .clear-search svg {
    width: 16px;
    height: 16px;
  }

  .search-stats {
    font-size: var(--font-size-sm);
    color: var(--color-gray-600);
    margin-bottom: var(--spacing-4);
  }

  .search-placeholder {
    text-align: center;
    color: var(--color-gray-500);
    padding: var(--spacing-8) 0;
  }

  .search-results {
    min-height: 200px;
  }

  .no-results {
    text-align: center;
    padding: var(--spacing-12) var(--spacing-4);
  }

  .no-results svg {
    width: 64px;
    height: 64px;
    color: var(--color-gray-300);
    margin-bottom: var(--spacing-4);
  }

  .no-results h3 {
    font-size: var(--font-size-lg);
    color: var(--color-gray-700);
    margin-bottom: var(--spacing-2);
  }

  .no-results p {
    color: var(--color-gray-500);
  }

  .search-result-card {
    display: flex;
    gap: var(--spacing-4);
    padding: var(--spacing-4);
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-gray-200);
    margin-bottom: var(--spacing-4);
    transition: all var(--transition-fast);
    text-decoration: none;
  }

  .search-result-card:hover {
    border-color: var(--color-primary-300);
    box-shadow: var(--shadow-md);
  }

  .search-result-image {
    flex-shrink: 0;
    width: 120px;
    height: 80px;
    border-radius: var(--radius-md);
    overflow: hidden;
    background: var(--color-gray-100);
  }

  .search-result-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .search-result-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-gray-300);
  }

  .search-result-placeholder svg {
    width: 32px;
    height: 32px;
  }

  .search-result-content {
    flex: 1;
    min-width: 0;
  }

  .search-result-category {
    display: inline-block;
    font-size: var(--font-size-xs);
    font-weight: 600;
    color: var(--color-primary-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--spacing-1);
  }

  .search-result-title {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--color-gray-900);
    margin-bottom: var(--spacing-1);
    line-height: 1.3;
  }

  .search-result-title :global(mark) {
    background: var(--color-primary-100);
    color: var(--color-primary-700);
    padding: 0 2px;
    border-radius: 2px;
  }

  .search-result-description {
    font-size: var(--font-size-sm);
    color: var(--color-gray-600);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    margin-bottom: var(--spacing-2);
  }

  .search-result-description :global(mark) {
    background: var(--color-primary-100);
    color: var(--color-primary-700);
    padding: 0 2px;
    border-radius: 2px;
  }

  .search-result-meta {
    font-size: var(--font-size-xs);
    color: var(--color-gray-500);
    display: flex;
    gap: var(--spacing-3);
  }

  .search-result-tags {
    color: var(--color-gray-400);
  }

  .popular-searches {
    margin-top: var(--spacing-8);
    padding-top: var(--spacing-8);
    border-top: 1px solid var(--color-gray-200);
  }

  .popular-searches h3 {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--color-gray-700);
    margin-bottom: var(--spacing-4);
  }

  .popular-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-2);
  }

  .popular-tag {
    padding: var(--spacing-2) var(--spacing-4);
    background: var(--color-gray-100);
    border: none;
    border-radius: var(--radius-full);
    font-size: var(--font-size-sm);
    color: var(--color-gray-700);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .popular-tag:hover {
    background: var(--color-primary-100);
    color: var(--color-primary-700);
  }

  @media (max-width: 640px) {
    .search-result-card {
      flex-direction: column;
    }

    .search-result-image {
      width: 100%;
      height: 150px;
    }
  }

  /* Dark mode */
  :global([data-theme="dark"]) .search-input {
    background: #1e293b;
    border-color: #334155;
    color: #f8fafc;
  }

  :global([data-theme="dark"]) .search-input:focus {
    border-color: var(--color-primary-500);
    box-shadow: 0 0 0 4px rgba(6, 182, 212, 0.2);
  }

  :global([data-theme="dark"]) .clear-search {
    background: #334155;
    color: #94a3b8;
  }

  :global([data-theme="dark"]) .clear-search:hover {
    background: #475569;
    color: #f8fafc;
  }

  :global([data-theme="dark"]) .search-stats {
    color: #94a3b8;
  }

  :global([data-theme="dark"]) .search-placeholder {
    color: #64748b;
  }

  :global([data-theme="dark"]) .no-results svg {
    color: #475569;
  }

  :global([data-theme="dark"]) .no-results h3 {
    color: #f8fafc;
  }

  :global([data-theme="dark"]) .no-results p {
    color: #94a3b8;
  }

  :global([data-theme="dark"]) .search-result-card {
    background: #1e293b;
    border-color: #334155;
  }

  :global([data-theme="dark"]) .search-result-card:hover {
    border-color: var(--color-primary-500);
  }

  :global([data-theme="dark"]) .search-result-image {
    background: #334155;
  }

  :global([data-theme="dark"]) .search-result-placeholder {
    color: #475569;
  }

  :global([data-theme="dark"]) .search-result-category {
    color: var(--color-primary-400);
  }

  :global([data-theme="dark"]) .search-result-title {
    color: #f8fafc;
  }

  :global([data-theme="dark"]) .search-result-title :global(mark) {
    background: rgba(6, 182, 212, 0.2);
    color: var(--color-primary-300);
  }

  :global([data-theme="dark"]) .search-result-description {
    color: #94a3b8;
  }

  :global([data-theme="dark"]) .search-result-description :global(mark) {
    background: rgba(6, 182, 212, 0.2);
    color: var(--color-primary-300);
  }

  :global([data-theme="dark"]) .search-result-meta {
    color: #64748b;
  }

  :global([data-theme="dark"]) .search-result-tags {
    color: #475569;
  }

  :global([data-theme="dark"]) .popular-searches {
    border-top-color: #334155;
  }

  :global([data-theme="dark"]) .popular-searches h3 {
    color: #cbd5e1;
  }

  :global([data-theme="dark"]) .popular-tag {
    background: #334155;
    color: #cbd5e1;
  }

  :global([data-theme="dark"]) .popular-tag:hover {
    background: rgba(6, 182, 212, 0.2);
    color: var(--color-primary-300);
  }
</style>
