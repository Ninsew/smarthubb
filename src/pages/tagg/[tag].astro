---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');

  // Samla alla unika taggar
  const allTags = new Set<string>();
  allPosts.forEach(post => {
    post.data.tags?.forEach(tag => allTags.add(tag.toLowerCase()));
  });

  return Array.from(allTags).map(tag => ({
    params: { tag },
    props: { tag }
  }));
}

const { tag } = Astro.params;
const displayTag = tag ? tag.charAt(0).toUpperCase() + tag.slice(1) : '';

// Hämta alla inlägg med denna tagg
const allPosts = await getCollection('blog');
const posts = allPosts
  .filter(post => post.data.tags?.map(t => t.toLowerCase()).includes(tag as string))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout title={`#${displayTag}`} description={`Alla artiklar taggade med ${displayTag}`}>

  <!-- Page Header -->
  <div class="blog-header">
    <div class="container">
      <div class="tag-header-content">
        <span class="tag-badge">#{displayTag}</span>
        <h1>Artiklar om {displayTag}</h1>
        <p>{posts.length} {posts.length === 1 ? 'artikel' : 'artiklar'} med denna tagg</p>
      </div>
    </div>
  </div>

  <!-- Articles -->
  <section class="section">
    <div class="container">
      {posts.length > 0 ? (
        <div class="articles-grid">
          {posts.map(post => (
            <a href={`/blog/${post.slug}`} class="article-card">
              <div class="article-card-image">
                {post.data.heroImage ? (
                  <img src={post.data.heroImage} alt={post.data.title} />
                ) : (
                  <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3">
                      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                      <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                  </div>
                )}
                {post.data.category && (
                  <span class="article-card-category">{post.data.category}</span>
                )}
              </div>
              <div class="article-card-content">
                <h2 class="article-card-title">{post.data.title}</h2>
                <p class="article-card-excerpt">{post.data.description}</p>
                <div class="article-card-meta">
                  <span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                      <line x1="16" y1="2" x2="16" y2="6"/>
                      <line x1="8" y1="2" x2="8" y2="6"/>
                      <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    {new Intl.DateTimeFormat('sv-SE', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                    }).format(post.data.pubDate)}
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <p>Inga artiklar hittades med denna tagg.</p>
          <a href="/blog" class="btn btn-primary">
            Se alla guider
          </a>
        </div>
      )}
    </div>
  </section>

</BaseLayout>

<style>
  .tag-header-content {
    max-width: 700px;
  }

  .tag-badge {
    display: inline-block;
    padding: var(--spacing-2) var(--spacing-4);
    background: rgba(255, 255, 255, 0.15);
    border-radius: var(--radius-full);
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin-bottom: var(--spacing-4);
  }

  .empty-state {
    text-align: center;
    padding: var(--spacing-16) var(--spacing-4);
  }

  .empty-state p {
    color: var(--color-gray-600);
    margin-bottom: var(--spacing-8);
  }

  /* Dark mode */
  :global([data-theme="dark"]) .empty-state p {
    color: #94a3b8;
  }
</style>
